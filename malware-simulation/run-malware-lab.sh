#!/usr/bin/env bash
# run-malware-lab.sh – Zero-risk automation for malware simulation lab
# Author: Leonardo Costa – DIO Cybersecurity Challenge
# ⚠️  ONLY run inside a VM or isolated container you own.

set -euo pipefail

LAB_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TEST_DIR="${LAB_DIR}/test_files"
VENV_DIR="${LAB_DIR}/venv"
LOG_DIR="${LAB_DIR}/evidence"
KEYLOG_TIMEOUT=10          # seconds
SKIP_EMAIL=${SKIP_EMAIL:-1} # 1 = disable e-mail by default

banner(){
  echo "=========================================="
  echo "Malware Simulation Lab – Zero-Risk Mode"
  echo "=========================================="
}

step(){
  echo "[*] $1"
}

die(){
  echo "[!] $1" >&2
  exit 1
}

# 1. Pre-flight checks
banner
step "Checking environment"
command -v python3 >/dev/null || die "python3 not found"
[[ -f "${LAB_DIR}/requirements.txt" ]] || die "requirements.txt missing"

# 2. Clean/Create sandbox
step "Creating sandbox directories"
rm -rf "${TEST_DIR}" "${LOG_DIR}"
mkdir -p "${TEST_DIR}" "${LOG_DIR}"

# 3. Python venv
if [[ ! -d "${VENV_DIR}" ]]; then
  step "Creating Python virtual environment"
  python3 -m venv "${VENV_DIR}"
fi
source "${VENV_DIR}/bin/activate"
step "Installing dependencies"
pip install -q -r requirements.txt

# 4. Ransomware simulation
step "Ransomware: generating test files"
echo "This is a dummy secret" > "${TEST_DIR}/secret.txt"
echo "Another file to encrypt" > "${TEST_DIR}/note.txt"

step "Ransomware: encrypting files"
python ransomware_sim.py | tee "${LOG_DIR}/ransomware.log"

step "Ransomware: decrypting files"
python ransomware_sim.py --decrypt | tee -a "${LOG_DIR}/ransomware.log"

# 5. Keylogger simulation (short-lived)
step "Keylogger: starting ${KEYLOG_TIMEOUT}s capture"
export LOG_FILE="${LOG_DIR}/keylog.txt"
SKIP_EMAIL=1 python keylogger_sim.py | tee "${LOG_DIR}/keylogger.log"

# 6. Evidence summary
step "Evidence saved to ${LOG_DIR}"
ls -lh "${LOG_DIR}"

step "Lab completed – zero-risk mode ✅"